var getUserMedia=null;var attachMediaStream=null;var reattachMediaStream=null;var webrtcDetectedBrowser=null;var webrtcDetectedVersion=null;if(navigator.mozGetUserMedia){webrtcDetectedBrowser="firefox";webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]);var matches=navigator.userAgent.match(/\srv:([0-9]+)\./);if(matches!==null&&matches.length>1){webrtcDetectedVersion=parseInt(matches[1])}window.RTCPeerConnection=mozRTCPeerConnection;window.RTCSessionDescription=mozRTCSessionDescription;window.RTCIceCandidate=mozRTCIceCandidate;window.getUserMedia=navigator.mozGetUserMedia.bind(navigator);window.createIceServer=function(b,f,a){var d=null;var e=b.split(":");var c;if(e[0].indexOf("stun")===0){d={url:b}}else{if(e[0].indexOf("turn")===0&&(b.indexOf("transport=udp")!==-1||b.indexOf("?transport")===-1)){c=b.split("?");d={url:c[0],credential:a,username:f}}}return d};attachMediaStream=function(a,b){a.mozSrcObject=b;a.play()};reattachMediaStream=function(b,a){b.mozSrcObject=a.mozSrcObject;b.play()};if(webrtcDetectedVersion<23){MediaStream.prototype.getVideoTracks=function(){return[]};MediaStream.prototype.getAudioTracks=function(){return[]}}}else{if(navigator.webkitGetUserMedia){webrtcDetectedBrowser="chrome";webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]);window.createIceServer=function(b,f,a){var c=null;var e;var d=b.split(":");if(d[0].indexOf("stun")===0){c={url:b}}else{if(d[0].indexOf("turn")===0){if(webrtcDetectedVersion<28){e=b.split("turn:");c={url:"turn:"+f+"@"+e[1],credential:a}}else{c={url:b,credential:a,username:f}}}}return c};window.RTCPeerConnection=webkitRTCPeerConnection;window.getUserMedia=navigator.webkitGetUserMedia.bind(navigator);attachMediaStream=function(a,b){if(typeof a.srcObject!=="undefined"){a.srcObject=b}else{if(typeof a.mozSrcObject!=="undefined"){a.mozSrcObject=b}else{if(typeof a.src!=="undefined"){a.src=URL.createObjectURL(b)}else{console.log("Error attaching stream to element.")}}}};reattachMediaStream=function(b,a){b.src=a.src};if(!webkitMediaStream.prototype.getVideoTracks){webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks};webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}}if(!webkitRTCPeerConnection.prototype.getLocalStreams){webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams};webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams}}}else{console.log("Browser does not appear to be WebRTC-capable")}}if(!window.createIceServer){window.createIceServer=function(a,c,b){return{url:a,credential:b,username:c}}}var Easyrtc=function(){var t=this;var i=(webrtcDetectedBrowser==="firefox");this.format=function(at,ao,an,am){var ar=arguments[0];for(var ap=1;ap<arguments.length;ap++){var aq=new RegExp("\\{"+(ap-1)+"\\}","gi");ar=ar.replace(aq,arguments[ap])}return ar};var n={audio:false,video:false};this.getConstantString=function(am){if(easyrtc_constantStrings[am]){return easyrtc_constantStrings[am]}else{console.warn("Could not find key='"+am+"' in easyrtc_constantStrings");return am}};var u={roomOccupant:true};var h={};function o(am,an){if(typeof am!=="string"){t.showError(t.errCodes.DEVELOPER_ERR,src+" called without a string as the first argument");throw"developer error"}if(!u[am]){t.showError(t.errCodes.DEVELOPER_ERR,src+" called with a bad event name = "+am);throw"developer error"}}this.addEventListener=function(an,am){o(an,"addEventListener");if(typeof am!=="function"){t.showError(t.errCodes.DEVELOPER_ERR,"addEventListener called with a non-function for second argument");throw"developer error"}t.removeEventListener(an,am);if(!h[an]){h[an]=[]}h[an][h[an].length]=am};this.removeEventListener=function(an,am){o(an,"removeEventListener");var ap=h[an];var ao=0;if(ap){for(ao=0;ao<ap.length;ao++){if(ap[ao]===am){if(ao<ap.length-1){ap[ao]=ap[ap.length-1]}ap.length=ap.length-1}}}};this.emitEvent=function(am,ap){o(am,"emitEvent");var ao=h[am];var an=0;if(ao){for(an=0;an<ao.length;an++){ao[an](am,ap)}}};this.errCodes={BAD_NAME:"BAD_NAME",CALL_ERR:"CALL_ERR",DEVELOPER_ERR:"DEVELOPER_ERR",SYSTEM_ERR:"SYSTEM_ERR",CONNECT_ERR:"CONNECT_ERR",MEDIA_ERR:"MEDIA_ERR",MEDIA_WARNING:"MEDIA_WARNING",INTERNAL_ERR:"INTERNAL_ERR",PEER_GONE:"PEER_GONE",ALREADY_CONNECTED:"ALREADY_CONNECTED",BAD_CREDENTIAL:"BAD_CREDENTIAL"};this.apiVersion="1.0.11";this.ackMessage={msgType:"ack"};this.usernameRegExp=/^(.){1,64}$/;this.cookieId="easyrtcsid";this.username=null;this.loggingOut=false;this.disconnecting=false;this.localStream=null;var C=[];var q={mandatory:{OfferToReceiveAudio:true,OfferToReceiveVideo:true}};this.enableAudioReceive=function(am){q.mandatory.OfferToReceiveAudio=am};this.enableVideoReceive=function(am){q.mandatory.OfferToReceiveVideo=am};this.getVideoSourceList=function(am){if(MediaStreamTrack.getSources){MediaStreamTrack.getSources(function(an){var ap=[];for(var ao=0;ao<an.length;ao++){var aq=an[ao];if(aq.kind==="video"){ap.push(aq)}}am(ap)})}else{am([])}};var Q=true;var d=true;var U=false;var y="dc";this.debugPrinter=null;this.myEasyrtcid="";var s={};var al={};var L=0;this.nativeVideoHeight=0;this.nativeVideoWidth=0;var aj=null;this.roomJoin={};this.isNameValid=function(am){return t.usernameRegExp.test(am)};this.setCookieId=function(am){t.cookieId=am};this.joinRoom=function(ar,au,av,aq){if(t.roomJoin[ar]){console.error("Developer error: attempt to join room "+ar+" which you are already in.");return}var am={roomName:ar};if(au){try{JSON.stringify(au)}catch(at){t.showError(t.errCodes.DEVELOPER_ERR,"non-jsonable parameter to easyrtc.joinRoom");throw"Developer error, see application error messages"}var ax={};for(var aw in au){if(au.hasOwnProperty(aw)){ax[aw]=au[aw]}}am.roomParameter=ax}var an={roomJoin:{}};var ay;var ao,ap;if(t.webSocket){an.roomJoin[ar]=am;ao=function(az,aA){ay=aA.roomData;t.roomJoin[ar]=am;if(av){av(ar)}V(ay)};ap=function(aA,az){if(aq){aq(aA,az,ar)}else{t.showError(aA,t.format(t.getConstantString("unableToEnterRoom"),ar,az))}};P(null,"roomJoin",an,ao,ap)}else{t.roomJoin[ar]=am}};this.leaveRoom=function(an,am,ap){var ao;if(t.roomJoin[an]){if(!t.webSocket){delete t.roomJoin[an]}else{ao={};ao[an]={roomName:an};P(null,"roomLeave",{roomLeave:ao},function(aq,ar){var at=ar.roomData;V(at);if(am){am(an)}},function(ar,aq){if(ap){ap(ar,aq,an)}})}}};this._desiredVideoProperties={};this.setVideoSource=function(am){t._desiredVideoProperties.videoSrcId=am;delete t._desiredVideoProperties.screenCapture};this.setVideoSrc=this.setVideoSource;delete this._desiredVideoProperties.screenCapture;this.setVideoDims=function(ao,am,an){if(!ao){ao=1280;am=720}t._desiredVideoProperties.width=ao;t._desiredVideoProperties.height=am;if(an!==undefined){t._desiredVideoProperties.frameRate=an}};this.setScreenCapture=function(){t._desiredVideoProperties.screenCapture=true};t.getUserMediaConstraints=function(){var am={};if(!d){am.video=false}else{if(t._desiredVideoProperties.screenCapture){return{video:{mandatory:{chromeMediaSource:"screen",maxWidth:screen.width,maxHeight:screen.height,minWidth:screen.width,minHeight:screen.height,minFrameRate:1,maxFrameRate:5},optional:[]}}}else{am.video={mandatory:{},optional:[]};if(t._desiredVideoProperties.width){am.video.mandatory.maxWidth=t._desiredVideoProperties.width;am.video.mandatory.minWidth=t._desiredVideoProperties.width}if(t._desiredVideoProperties.width){am.video.mandatory.maxHeight=t._desiredVideoProperties.height;am.video.mandatory.minHeight=t._desiredVideoProperties.height}if(t._desiredVideoProperties.frameRate){am.video.mandatory.maxFrameRate=t._desiredVideoProperties.frameRate}if(t._desiredVideoProperties.videoSrcId){am.video.optional.push({sourceId:t._desiredVideoProperties.videoSrcId})}}}am.audio=Q;return am};this.setApplicationName=function(am){t.applicationName=am};this.enableDebug=function(am){if(am){t.debugPrinter=function(ap){var aq=new Error().stack;var ao="location unknown";if(aq){var an=aq.split("\n");ao="";if(an.length>=3){ao=an[2]}}console.log("debug "+(new Date()).toISOString()+" : "+ap+" ["+ao+"]")}}else{t.debugPrinter=null}};this.updatePresence=function(am,an){t.presenceShow=am;t.presenceStatus=an};this.supportsGetUserMedia=function(){return !!getUserMedia};this.supportsPeerConnections=function(){if(!t.supportsGetUserMedia()){return false}if(!window.RTCPeerConnection){return false}try{t.createRTCPeerConnection({iceServers:[]},null)}catch(am){return false}return true};this.createRTCPeerConnection=function(am,an){if(RTCPeerConnection){return new RTCPeerConnection(am,an)}else{throw"Your browser doesn't support webRTC (RTCPeerConnection)"}};this.getDatachannelConstraints=function(){if(webrtcDetectedBrowser==="chrome"&&webrtcDetectedVersion<31){return{reliable:false}}else{return{reliable:true}}};n={audio:false,video:false};var af=false;var T=null;var ag=null;var l=null;var B=null;var b={};var F={msgTypes:{}};var N=null;var w=function(){};var k={};var v={};this.disconnect=function(){};this.acceptCheck=function(am,an){an(true)};this.streamAcceptor=function(am,an){};this.onStreamClosed=function(am){};this.callCancelled=function(am){};this.getPeerStatistics=function(am,ao,an){if(i){t.getFirefoxPeerStatistics(am,ao,an)}else{t.getChromePeerStatistics(am,ao,an)}};this.getFirefoxPeerStatistics=function(am,ao,an){if(!k[am]){ao({notConnected:am})}else{if(k[am].pc.getStats){k[am].pc.getStats(null,function(aq){var ap={};var at;aq.forEach(function(av){var au;var aw;if(av.type.match(/boundrtp/)){if(av.id.match(/audio/)){au=av.type+"_audio"}else{if(av.id.match(/video/)){au=av.type+"_video"}else{return}}for(aw in av){if(av.hasOwnProperty(aw)){ap[au+"."+aw]=av[aw]}}}});if(!an){ao(am,ap)}else{var ar={};for(at in an){if(an.hasOwnProperty(at)&&ap.hasOwnProperty(at)){ar[an[at]]=ap[at]}}ao(am,ar)}},function(ap){console.log("unable to get statistics")})}else{ao({statistics:t.getConstantString("statsNotSupported")})}}};this.getChromePeerStatistics=function(am,ao,an){if(!k[am]){ao({notConnected:am})}else{if(k[am].pc.getStats){k[am].pc.getStats(function(aI){var az={};var aA,ay=aI.result();var aC,aB;var av;var aH;var ax;var ar;var aw=[];var aF;var au=0;var ap;var aq=null;var aE,aD;var at,aJ;if(!an){for(aC=0;aC<ay.length;aC++){ax=ay[aC].names();for(aB=0;aB<ax.length;aB++){aH=ax[aB];az[ay[aC].id+"."+aH]=ay[aC].local.stat(aH)}}}else{for(aC=0;aC<ay.length;aC++){aw[aC]={};ax=ay[aC].names();for(aB=0;aB<ax.length;aB++){aw[aC][ax[aB]]=true}if(aw[aC].googRemoteAddress&&aw[aC].googActiveConnection){aE=ay[aC].local.stat("googActiveConnection");if(aE===true||aE==="true"){aD=parseInt(ay[aC].local.stat("bytesReceived"))+parseInt(ay[aC].local.stat("bytesSent"));if(aD>au){ap=aC;au=aD}}}}for(aC=0;aC<ay.length;aC++){if(aw[aC].googActiveConnection){if(aC!==ap){aw[aC]={}}else{at=ay[aC].local.stat("googLocalAddress").split(":")[0];aJ=ay[aC].local.stat("googRemoteAddress").split(":")[0];if(t.isTurnServer(at)){aq=at}else{if(t.isTurnServer(aJ)){aq=aJ}}}}}for(aC=0;aC<an.length;aC++){av=an[aC];aF=[];aA=null;for(aB=0;aB<ay.length;aB++){var aG=true;for(aH in av){if(av.hasOwnProperty(aH)&&!aw[aB][aH]){aG=false;break}}if(aG&&ay[aB]){aF.push(ay[aB])}}if(aF.length===1){for(aB=0;aB<aF.length;aB++){aA=aF[aB];if(aA.local){for(aH in av){if(av.hasOwnProperty(aH)){ar=av[aH];az[ar]=aA.local.stat(aH)}}}}}else{if(aF.length>1){for(aH in av){if(av.hasOwnProperty(aH)){az[av[aH]]=[]}}for(aB=0;aB<aF.length;aB++){aA=aF[aB];if(aA.local){for(aH in av){if(av.hasOwnProperty(aH)){ar=av[aH];az[ar].push(aA.local.stat(aH))}}}}}}}}if(az.remoteAddress&&aq){az.remoteAddress=aq}ao(am,az)})}else{ao({statistics:t.getConstantString("statsNotSupported")})}}};this.chromeStatsFilter=[{googTransmitBitrate:"transmitBitRate",googActualEncBitrate:"encodeRate",googAvailableSendBandwidth:"availableSendRate"},{googCodecName:"audioCodec",googTypingNoiseState:"typingNoise",packetsSent:"audioPacketsSent"},{googCodecName:"videoCodec",googFrameRateSent:"outFrameRate",packetsSent:"videoPacketsSent"},{packetsLost:"videoPacketsLost",packetsReceived:"videoPacketsReceived",googFrameRateOutput:"frameRateOut"},{packetsLost:"audioPacketsLost",packetsReceived:"audioPacketsReceived",audioOutputLevel:"audioOutputLevel"},{googRemoteAddress:"remoteAddress",googActiveConnection:"activeConnection"},{audioInputLevel:"audioInputLevel"}];this.firefoxStatsFilter={"outboundrtp_audio.packetsSent":"audioPacketsSent","outboundrtp_video.packetsSent":"videoPacketsSent","inboundrtp_video.packetsReceived":"videoPacketsReceived","inboundrtp_audio.packetsReceived":"audioPacketsReceived"};this.standardStatsFilter=i?t.firefoxStatsFilter:t.chromeStatsFilter;this.setRoomApiField=function(an,ap,ao){if(!t._roomApiFields){t._roomApiFields={}}if(!ap&&!ao){delete t._roomApiFields[an];return}if(!t._roomApiFields[an]){t._roomApiFields[an]={}}if(ao!==undefined&&ao!==null){if(typeof ao==="object"){try{JSON.stringify(ao)}catch(am){t.showError(t.errCodes.DEVELOPER_ERR,"easyrtc.setRoomApiField passed bad object ");return}}t._roomApiFields[an][ap]={fieldName:ap,fieldValue:ao}}else{delete t._roomApiFields[an][ap]}if(t.webSocketConnected){O(an)}};var g=null;function O(am){if(g){clearTimeout(g)}g=setTimeout(function(){p(am,t._roomApiFields[am]);g=null},10)}function p(an,am){var ao=JSON.stringify(am);JSON.parse(ao);var ap={msgType:"setRoomApiField",msgData:{setRoomApiField:{roomName:an,field:am}}};t.webSocket.json.emit("easyrtcCmd",ap,function(aq){if(aq.msgType==="error"){t.showError(aq.msgData.errorCode,aq.msgData.errorText)}})}this.showError=function(am,an){t.onError({errorCode:am,errorText:an})};this.onError=function(ao){if(t.debugPrinter){t.debugPrinter("saw error "+ao.errorText)}var ap=document.getElementById("easyrtcErrorDialog");var am;if(!ap){ap=document.createElement("div");ap.id="easyrtcErrorDialog";var aq=document.createElement("div");aq.innerHTML="Error messages";aq.className="easyrtcErrorDialog_title";ap.appendChild(aq);am=document.createElement("div");am.id="easyrtcErrorDialog_body";ap.appendChild(am);var ar=document.createElement("button");ar.appendChild(document.createTextNode("Okay"));ar.className="easyrtcErrorDialog_okayButton";ar.onclick=function(){am.innerHTML="";ap.style.display="none"};ap.appendChild(ar);document.body.appendChild(ap)}am=document.getElementById("easyrtcErrorDialog_body");var an=document.createElement("div");an.className="easyrtcErrorDialog_element";an.appendChild(document.createTextNode(ao.errorText));am.appendChild(an);ap.style.display="block"};this.createObjectURL=function(am){var an;if(window.URL&&window.URL.createObjectURL){return window.URL.createObjectURL(am)}else{if(window.webkitURL&&window.webkitURL.createObjectURL){return window.webkit.createObjectURL(am)}else{an="Your browsers does not support URL.createObjectURL.";if(t.debugPrinter){t.debugPrinter("saw exception "+an)}throw an}}};this.cleanId=function(am){var an={"&":"&amp;","<":"&lt;",">":"&gt;"};return am.replace(/[&<>]/g,function(ao){return an[ao]})};t.setRoomEntryListener=function(am){t.roomEntryListener=am};t.setRoomOccupantListener=function(am){ag=am};this.setDataChannelOpenListener=function(am){l=am};this.setDataChannelCloseListener=function(am){B=am};this.getConnectionCount=function(){var an=0;var am;for(am in k){if(k.hasOwnProperty(am)){if(k[am].startedAV){an++}}}return an};this.enableAudio=function(am){Q=am};this.enableVideo=function(am){d=am};this.enableDataChannels=function(am){af=am};function z(ao,an){var ap;if(an){for(ap=0;ap<an.length;ap++){var am=an[ap];am.enabled=ao}}}this.enableCamera=function(am){if(t.localStream&&t.localStream.getVideoTracks){z(am,t.localStream.getVideoTracks())}};this.enableMicrophone=function(am){if(t.localStream&&t.localStream.getAudioTracks){z(am,t.localStream.getAudioTracks())}};t.muteVideoObject=function(am,ao){var an;if(typeof(am)==="string"){an=document.getElementById(am);if(!an){throw"Unknown video object "+am}}else{if(!am){throw"muteVideoObject passed a null"}else{an=am}}an.muted=!!ao};t.getLocalStreamAsUrl=function(){if(t.localStream===null){throw"Developer error: attempt to get a MediaStream without invoking easyrtc.initMediaSource successfully"}return t.createObjectURL(t.localStream)};this.getLocalStream=function(){return t.localStream};this.clearMediaStream=function(am){if(typeof am.srcObject!=="undefined"){am.srcObject=null}else{if(typeof am.mozSrcObject!=="undefined"){am.mozSrcObject=null}else{if(typeof am.src!=="undefined"){am.src=""}}}};this.setVideoObjectSrc=function(am,an){if(an&&an!==""){am.autoplay=true;attachMediaStream(am,an);am.play()}else{t.clearMediaStream(am)}};this.loadStylesheet=function(){var ao=document.getElementsByTagName("link");var ar,ap;for(ar in ao){if(ao.hasOwnProperty(ar)){ap=ao[ar];if(ap.href&&(ap.href.match(/\/easyrtc.css/))){return}}}var an=document.createElement("link");an.setAttribute("rel","stylesheet");an.setAttribute("type","text/css");an.setAttribute("href","/easyrtc/easyrtc.css");var am=document.getElementsByTagName("head")[0];var aq=am.childNodes[0];am.insertBefore(an,aq)};this.formatError=function(an){var ap,am;if(an===null||typeof an==="undefined"){return"null"}if(typeof an==="string"){return an}else{if(an.type&&an.description){return an.type+" : "+an.description}else{if(typeof an==="object"){try{return JSON.stringify(an)}catch(ao){am="{";for(ap in an){if(an.hasOwnProperty(ap)){if(typeof an[ap]==="string"){am=am+ap+"='"+an[ap]+"' "}}}am=am+"}";return am}}else{return"Strange case"}}}};this.initMediaSource=function(am,an){if(t.debugPrinter){t.debugPrinter("about to request local media")}n={audio:Q,video:d};if(!an){an=function(ax,av){var aw="easyrtc.initMediaSource: "+t.formatError(av);if(t.debugPrinter){t.debugPrinter(aw)}t.showError(t.errCodes.MEDIA_ERR,aw)}}if(!t.supportsGetUserMedia()){an(t.errCodes.MEDIA_ERR,t.getConstantString("noWebrtcSupport"));return}if(!am){t.showError(t.errCodes.DEVELOPER_ERR,"easyrtc.initMediaSource not supplied a successCallback");return}var au=t.getUserMediaConstraints();var ap=function(az){if(t.debugPrinter){t.debugPrinter("getUserMedia success callback entered")}if(t.debugPrinter){t.debugPrinter("successfully got local media")}t.localStream=az;var aw,av,ax,ay;if(n.video){aw=document.createElement("video");aw.muted=true;av=30;ax=function(){if(aw.videoWidth>0||av<0){t.nativeVideoWidth=aw.videoWidth;t.nativeVideoHeight=aw.videoHeight;if(t._desiredVideoProperties.height&&(t.nativeVideoHeight!==t._desiredVideoProperties.height||t.nativeVideoWidth!==t._desiredVideoProperties.width)){t.showError(t.errCodes.MEDIA_WARNING,t.format(t.getConstantString("resolutionWarning"),t._desiredVideoProperties.width,t._desiredVideoProperties.height,t.nativeVideoWidth,t.nativeVideoHeight))}t.setVideoObjectSrc(aw,"");if(aw.removeNode){aw.removeNode(true)}else{ay=document.createElement("div");ay.appendChild(aw);ay.removeChild(aw)}w();if(am){am()}}else{av-=1;setTimeout(ax,300)}};t.setVideoObjectSrc(aw,az);ax()}else{w();if(am){am()}}};var ao=function(av){console.log("getusermedia failed");if(t.debugPrinter){t.debugPrinter("failed to get local media")}var aw;if(typeof av==="string"){aw=av}else{if(av.name){aw=av.name}else{aw="Unknown"}}if(an){console.log("invoking error callback",aw);an(t.errCodes.MEDIA_ERR,t.format(t.getConstantString("gumFailed"),aw))}t.localStream=null;n={audio:false,video:false};w()};if(!Q&&!d){ao(t.getConstantString("requireAudioOrVideo"));return}function ar(){return(new Date()).getTime()}var at;function aq(av){var aw=ar();if(aw<at+1000){console.log("Trying getUserMedia a second time");setTimeout(function(){getUserMedia(au,ap,ao)},3000)}else{ao(av)}}if(d||Q){setTimeout(function(){try{at=ar();getUserMedia(au,ap,aq)}catch(av){aq(av)}},1000)}else{ap(null)}};this.setAcceptChecker=function(am){t.acceptCheck=am};this.setStreamAcceptor=function(am){t.streamAcceptor=am};t.setOnError=function(am){t.onError=am};this.setCallCancelled=function(am){t.callCancelled=am};this.setOnStreamClosed=function(am){t.onStreamClosed=am};this.setVideoBandwidth=function(am){t.showError("easyrtc.setVideoBandwidth is deprecated, it no longer has an effect.")};this.supportsDataChannels=function(){if(navigator.userAgent.match(/android/i)){return webrtcDetectedVersion>=34}else{return(webrtcDetectedBrowser==="firefox"||webrtcDetectedVersion>=32)}};this.setPeerListener=function(ao,am,an){if(!am){F.cb=ao}else{if(!F.msgTypes[am]){F.msgTypes[am]={sources:{}}}if(!an){F.msgTypes[am].cb=ao}else{F.msgTypes[am].sources[an]={cb:ao}}}};this.receivePeerDistribute=function(ap,aq,ao){var am=aq.msgType;var an=aq.msgData;if(!am){console.log("received peer message without msgType",aq);return}if(F.msgTypes[am]){if(F.msgTypes[am].sources[ap]&&F.msgTypes[am].sources[ap].cb){F.msgTypes[am].sources[ap].cb(ap,am,an,ao);return}if(F.msgTypes[am].cb){F.msgTypes[am].cb(ap,am,an,ao);return}}if(F.cb){F.cb(ap,am,an,ao)}};this.setServerListener=function(am){N=am};this.setSocketUrl=function(am){if(t.debugPrinter){t.debugPrinter("WebRTC signaling server URL set to "+am)}T=am};this.setUsername=function(am){if(t.isNameValid(am)){t.username=am;return true}else{t.showError(t.errCodes.BAD_NAME,t.format(t.getConstantString("badUserName"),am));return false}};this.usernameToIds=function(aq,ao){var an=[];var ap,am;for(am in b){if(!b.hasOwnProperty(am)){continue}if(ao&&am!==ao){continue}for(ap in b[am]){if(!b[am].hasOwnProperty(ap)){continue}if(b[am][ap].username===aq){an.push({easyrtcid:ap,roomName:am})}}}return an};this.getRoomApiField=function(am,an,ao){if(b[am]&&b[am][an]&&b[am][an].apiField&&b[am][an].apiField[ao]){return b[am][an].apiField[ao].fieldValue}else{return undefined}};this.setCredential=function(am){try{JSON.stringify(am);aj=am;return true}catch(an){t.showError(t.errCodes.BAD_CREDENTIAL,"easyrtc.setCredential passed a non-JSON-able object");throw"easyrtc.setCredential passed a non-JSON-able object"}};this.setDisconnectListener=function(am){t.disconnectListener=am};this.idToName=function(an){var am;for(am in b){if(!b.hasOwnProperty(am)){continue}if(b[am][an]){if(b[am][an].username){return b[am][an].username}}}return an};this.webSocket=null;var I={};var H=null;function A(ap,ao){var ar,aq;if(!ap){ar=t.localStream}else{aq=k[ap];if(!aq){console.error("Developer error: haveTracks called about a peer you don't have a connection to");return false}ar=aq.stream}if(!ar){return false}var an;try{if(ao){an=ar.getAudioTracks()}else{an=ar.getVideoTracks()}}catch(am){return true}if(!an){return false}return an.length>0}this.haveAudioTrack=function(am){return A(am,true)};this.haveVideoTrack=function(am){return A(am,false)};this.getRoomField=function(an,ao){var am=t.getRoomFields(an);if(!am||!am[ao]){return undefined}return am[ao].fieldValue};this.supportsStatistics=function(){var an;try{an=new RTCPeerConnection({iceServers:[]},{});return !!an.getStats}catch(am){return false}};var c=null;function ai(an){if(an===null||an===undefined){return true}var am;for(am in an){if(an.hasOwnProperty(am)){return false}}return true}function r(){var am;t.loggingOut=true;al={};v={};t.disconnecting=true;H=t.webSocket;if(t.webSocketConnected){t.webSocket.close();t.webSocketConnected=false}t.hangupAll();if(ag){for(am in b){if(b.hasOwnProperty(am)){ag(am,{},false)}}}t.emitEvent("roomOccupant",{});t.loggingOut=false;t.disconnecting=false;s={}}this.disconnect=function(){if(t.debugPrinter){t.debugPrinter("attempt to disconnect from WebRTC signalling server")}t.disconnecting=true;t.hangupAll();t.loggingOut=true;setTimeout(function(){if(t.webSocket){try{t.webSocket.disconnect()}catch(am){}H=t.webSocket;t.webSocket=0}t.loggingOut=false;t.disconnecting=false;if(ag){ag(null,{},false)}t.emitEvent("roomOccupant",{});s={}},250)};function P(aq,an,ap,am,ao){if(!t.webSocket){throw"Attempt to send message without a valid connection to the server."}else{var ar={msgType:an};if(aq){ar.targetEasyrtcid=aq}if(ap){ar.msgData=ap}if(t.debugPrinter){t.debugPrinter("sending socket message "+JSON.stringify(ar))}t.webSocket.json.emit("easyrtcCmd",ar,function(at){if(at.msgType!=="error"){if(am){am(at.msgType,at.msgData)}}else{if(ao){ao(at.msgData.errorCode,at.msgData.errorText)}else{t.showError(at.msgData.errorCode,at.msgData.errorText)}}})}}this.sendDataP2P=function(aq,am,ap){var ao=JSON.stringify({msgType:am,msgData:ap});if(t.debugPrinter){t.debugPrinter("sending p2p message to "+aq+" with data="+JSON.stringify(ao))}if(!k[aq]){t.showError(t.errCodes.DEVELOPER_ERR,"Attempt to send data peer to peer without a connection to "+aq+" first.")}else{if(!k[aq].dataChannelS){t.showError(t.errCodes.DEVELOPER_ERR,"Attempt to send data peer to peer without establishing a data channel to "+aq+" first.")}else{if(!k[aq].dataChannelReady){t.showError(t.errCodes.DEVELOPER_ERR,"Attempt to use data channel to "+aq+" before it's ready to send.")}else{try{k[aq].dataChannelS.send(ao)}catch(an){console.log("error=",an);throw an}}}}};this.sendDataWS=function(am,an,ao,aq){if(t.debugPrinter){t.debugPrinter("sending client message via websockets to "+am+" with data="+JSON.stringify(ao))}if(!aq){aq=function(ar){if(ar.msgType==="error"){t.showError(ar.msgData.errorCode,ar.msgData.errorText)}}}var ap={msgType:an,msgData:ao};if(am){if(typeof am==="string"){ap.targetEasyrtcid=am}else{if(typeof am==="object"){if(am.targetEasyrtcid){ap.targetEasyrtcid=am.targetEasyrtcid}if(am.targetRoom){ap.targetRoom=am.targetRoom}if(am.targetGroup){ap.targetGroup=am.targetGroup}}}}if(t.webSocket){t.webSocket.json.emit("easyrtcMsg",ap,aq)}else{if(t.debugPrinter){t.debugPrinter("websocket failed because no connection to server")}throw"Attempt to send message without a valid connection to the server."}};this.sendData=function(ao,am,an,ap){if(k[ao]&&k[ao].dataChannelReady){t.sendDataP2P(ao,am,an)}else{t.sendDataWS(ao,am,an,ap)}};this.sendPeerMessage=function(am,an,ao,ap,ar){if(!am){console.error("Developer error, destination was null in sendPeerMessage")}if(t.debugPrinter){t.debugPrinter("sending peer message "+JSON.stringify(ao))}function aq(at){if(at.msgType==="error"){if(ar){ar(at.msgData.errorCode,at.msgData.errorText)}}else{if(ap){ap(at.msgType,at.msgData?at.msgData:null)}}}t.sendDataWS(am,an,ao,aq)};this.sendServerMessage=function(am,an,ao,ar){if(t.debugPrinter){var aq={msgType:am,msgData:an};t.debugPrinter("sending server message "+JSON.stringify(aq))}function ap(at){if(at.msgType==="error"){if(ar){ar(at.msgData.errorCode,at.msgData.errorText)}}else{if(ao){ao(at.msgType,at.msgData?at.msgData:null)}}}t.sendDataWS(null,am,an,ap)};this.getRoomList=function(an,am){P(null,"getRoomList",null,function(ao,ap){an(ap.roomList)},function(ap,ao){if(am){am(ap,ao)}else{t.showError(ap,ao)}})};this.NOT_CONNECTED="not connected";this.BECOMING_CONNECTED="connection in progress to us.";this.IS_CONNECTED="is connected";this.getConnectStatus=function(am){if(typeof k[am]==="undefined"){return t.NOT_CONNECTED}var an=k[am];if((an.sharingAudio||an.sharingVideo)&&!an.startedAV){return t.BECOMING_CONNECTED}else{if(an.sharingData&&!an.dataChannelReady){return t.BECOMING_CONNECTED}else{return t.IS_CONNECTED}}};function S(){var am=[];am.push({DtlsSrtpKeyAgreement:"true"});return{optional:am}}this.call=function(an,am,ap,ar){if(t.debugPrinter){t.debugPrinter("initiating peer to peer call to "+an+" audio="+Q+" video="+d+" data="+af)}if(!t.supportsPeerConnections()){ap(t.errCodes.CALL_ERR,t.getConstantString("noWebrtcSupport"));return}var aq;if(t.localStream===null&&(Q||d)){t.initMediaSource(function(){t.call(an,am,ap,ar)},ap);return}if(!t.webSocket){aq="Attempt to make a call prior to connecting to service";if(t.debugPrinter){t.debugPrinter(aq)}throw aq}if(al[an]){ar(true);X(an,al[an]);delete al[an];t.callCancelled(an,false);return}if(typeof v[an]!=="undefined"){aq="Call already pending acceptance";if(t.debugPrinter){t.debugPrinter(aq)}ap(t.errCodes.ALREADY_CONNECTED,aq);return}v[an]=true;var ao=f(an,true,ap);if(!ao){aq="buildPeerConnection failed, call not completed";if(t.debugPrinter){t.debugPrinter(aq)}throw aq}k[an].callSuccessCB=am;k[an].callFailureCB=ap;k[an].wasAcceptedCB=ar;var at=k[an];var au=function(av){if(at.cancelled){return}var aw=function(){P(an,"offer",av,null,ap)};ao.setLocalDescription(av,aw,function(ax){ap(t.errCodes.CALL_ERR,ax)})};setTimeout(function(){ao.createOffer(au,function(av){ap(t.errCodes.CALL_ERR,JSON.stringify(av))},q)},100)};function ab(am){if(t.debugPrinter){t.debugPrinter("Hanging up on "+am)}e(am);if(k[am]){if(k[am].startedAV){try{k[am].pc.close()}catch(an){}if(t.onStreamClosed){t.onStreamClosed(am)}}k[am].cancelled=true;delete k[am];if(t.webSocket){P(am,"hangup",null,function(){},function(ap,ao){if(t.debugPrinter){t.debugPrinter("hangup failed:"+ao)}})}if(v[am]){delete v[am]}}}this.hangup=function(am){ab(am);w()};this.hangupAll=function(){var ao=false,ap=function(){},an=function(ar,aq){if(t.debugPrinter){t.debugPrinter("hangup failed:"+aq)}};for(var am in k){if(!k.hasOwnProperty(am)){continue}ao=true;ab(am);if(t.webSocket){P(am,"hangup",null,ap,an)}}if(ao){w()}};this.doesDataChannelWork=function(am){if(!k[am]){return false}return !!k[am].dataChannelReady};function Y(){var am;for(am in k){if(!k.hasOwnProperty(am)){continue}if(k[am].pc){var an=k[am].pc.getRemoteStreams();if(an.length>0){t.localStream=an[0];break}}}}var f=function(aq,ap,at){var aw;var ay;var an;if(t.debugPrinter){t.debugPrinter("building peer connection to "+aq)}try{aw=t.createRTCPeerConnection(I,S());if(!aw){ay="Unable to create PeerConnection object, check your ice configuration("+JSON.stringify(I)+")";if(t.debugPrinter){t.debugPrinter(ay)}throw (ay)}if(af&&typeof aw.createDataChannel==="undefined"){af=false}aw.onconnection=function(){if(t.debugPrinter){t.debugPrinter("onconnection called prematurely")}};an={pc:aw,candidatesToSend:[],startedAV:false,isInitiator:ap};aw.onicecandidate=function(aA){if(an.cancelled){return}var aB;if(aA.candidate&&k[aq]){aB={type:"candidate",label:aA.candidate.sdpMLineIndex,id:aA.candidate.sdpMid,candidate:aA.candidate.candidate};if(aA.candidate.candidate.indexOf("typ relay")>0){var az=aA.candidate.candidate.match(/(udp|tcp) \d+ (\d+\.\d+\.\d+\.\d+)/i)[2];t._turnServers[az]=true}if(k[aq].startedAV){P(aq,"candidate",aB,null,function(){at(t.errCodes.PEER_GONE,"Candidate disappeared")})}else{k[aq].candidatesToSend.push(aB)}}};aw.onaddstream=function(az){if(t.debugPrinter){t.debugPrinter("saw incoming media stream")}if(an.cancelled){return}k[aq].startedAV=true;k[aq].sharingAudio=n.audio;k[aq].sharingVideo=n.video;k[aq].connectTime=new Date().getTime();k[aq].stream=az.stream;if(k[aq].callSuccessCB){if(k[aq].sharingAudio||k[aq].sharingVideo){k[aq].callSuccessCB(aq,"audiovideo")}}if(Q||d){R()}if(t.streamAcceptor){t.streamAcceptor(aq,az.stream)}};aw.onremovestream=function(az){if(t.debugPrinter){t.debugPrinter("saw remove on remote media stream")}if(k[aq]){k[aq].stream=null;if(t.onStreamClosed){t.onStreamClosed(aq)}w()}};k[aq]=an}catch(au){if(t.debugPrinter){t.debugPrinter(JSON.stringify(au))}at(t.errCodes.SYSTEM_ERR,au.message);return null}if(U){if(!t.localStream){Y()}if(t.localStream){aw.addStream(t.localStream)}}else{if(d||Q){if(t.localStream===null){ay="Developer error: attempt to share audio or video before calling easyrtc.initMediaSource.";if(t.debugPrinter){t.debugPrinter(ay)}t.showError(t.errCodes.DEVELOPER_ERR,ay);console.error(ay)}else{if(t.debugPrinter){t.debugPrinter("adding local media stream to peer connection")}aw.addStream(t.localStream)}}}function ar(aA){if(t.debugPrinter){t.debugPrinter("saw dataChannel.onmessage event: "+JSON.stringify(aA.data))}if(aA.data==="dataChannelPrimed"){t.sendDataWS(aq,"dataChannelPrimed","")}else{try{var aB=JSON.parse(aA.data);if(aB){t.receivePeerDistribute(aq,aB,null)}}catch(az){}}}function ao(az){if(t.debugPrinter){t.debugPrinter("saw initOutgoingChannel call")}var aA=aw.createDataChannel(y,t.getDatachannelConstraints());k[az].dataChannelS=aA;k[az].dataChannelR=aA;aA.onmessage=ar;aA.onopen=function(aB){if(t.debugPrinter){t.debugPrinter("saw dataChannel.onopen event")}if(k[az]){aA.send("dataChannelPrimed")}};aA.onclose=function(aB){if(t.debugPrinter){t.debugPrinter("saw dataChannelS.onclose event")}if(k[az]){k[az].dataChannelReady=false;delete k[az].dataChannelS}if(B){B(az)}w()}}function av(az){if(t.debugPrinter){t.debugPrinter("initializing incoming channel handler for "+az)}k[az].pc.ondatachannel=function(aB){if(t.debugPrinter){t.debugPrinter("saw incoming data channel")}var aA=aB.channel;k[az].dataChannelR=aA;k[az].dataChannelS=aA;k[az].dataChannelReady=true;aA.onmessage=ar;aA.onclose=function(aC){if(t.debugPrinter){t.debugPrinter("saw dataChannelR.onclose event")}if(k[az]){k[az].dataChannelReady=false;delete k[az].dataChannelR}if(B){B(az)}w()};aA.onopen=function(aC){if(t.debugPrinter){t.debugPrinter("saw dataChannel.onopen event")}if(k[az]){aA.send("dataChannelPrimed")}}}}var ax=af;if(ax){}if(ax){t.setPeerListener(function(){k[aq].dataChannelReady=true;if(k[aq].callSuccessCB){k[aq].callSuccessCB(aq,"datachannel")}if(l){l(aq,true)}w()},"dataChannelPrimed",aq);if(ap){try{ao(aq)}catch(am){console.log("failed to init outgoing channel");at(t.errCodes.SYSTEM_ERR,t.formatError(am))}}if(!ap){av(aq)}}aw.onconnection=function(){if(t.debugPrinter){t.debugPrinter("setup pc.onconnection ")}};return aw};var X=function(ar,aq){if(U){if(!t.localStream){Y()}}else{if(!t.localStream&&(d||Q)){t.initMediaSource(function(){X(ar,aq)},function(aw,av){t.showError(t.errCodes.MEDIA_ERR,t.format(t.getConstantString("localMediaError")))});return}}var ap=f(ar,false,function(av){t.showError(t.errCodes.SYSTEM_ERR,av)});var am=k[ar];if(!ap){if(t.debugPrinter){t.debugPrinter("buildPeerConnection failed. Call not answered")}return}var au=function(aw){if(am.cancelled){return}var av=function(){if(t.debugPrinter){t.debugPrinter("sending answer")}P(ar,"answer",aw,null,function(ay,ax){delete k[ar];t.showError(ay,ax)});k[ar].startedAV=true;if(ap.connectDataConnection){if(t.debugPrinter){t.debugPrinter("calling connectDataConnection(5002,5001)")}ap.connectDataConnection(5002,5001)}};ap.setLocalDescription(aw,av,function(ax){t.showError(t.errCodes.INTERNAL_ERR,"setLocalDescription: "+ax)})};var at=null;if(window.mozRTCSessionDescription){at=new mozRTCSessionDescription(aq)}else{at=new RTCSessionDescription(aq)}if(t.debugPrinter){t.debugPrinter("sdp ||  "+JSON.stringify(at))}var ao=function(){if(am.cancelled){return}ap.createAnswer(au,function(av){t.showError(t.errCodes.INTERNAL_ERR,"create-answer: "+av)},q)};if(t.debugPrinter){t.debugPrinter("about to call setRemoteDescription in doAnswer")}try{ap.setRemoteDescription(at,ao,function(av){t.showError(t.errCodes.INTERNAL_ERR,"set-remote-description: "+av)})}catch(an){console.log("set remote description failed");if(t.debugPrinter){t.debugPrinter("saw exception in setRemoteDescription")}t.showError(t.errCodes.INTERNAL_ERR,"setRemoteDescription failed: "+an.message)}};var j=function(an){delete al[an];if(t.debugPrinter){t.debugPrinter("Saw onRemote hangup event")}if(k[an]){k[an].cancelled=true;if(k[an].startedAV){if(t.onStreamClosed){t.onStreamClosed(an)}}else{if(t.callCancelled){t.callCancelled(an,true)}}try{k[an].pc.close()}catch(am){}delete k[an];w()}else{if(t.callCancelled){t.callCancelled(an,true)}}};var G={};var e=function(am){G[am]={candidates:[]}};function D(an){var am;for(am in b){if(!b.hasOwnProperty(am)){continue}if(b[am][an]){return true}}return false}function ad(am){var an;for(an in k){if(k.hasOwnProperty(an)&&typeof am[an]==="undefined"){if(!D(an)){if(k[an].startedAV||k[an].isInitiator){j(an)}delete al[an];delete v[an];e(an)}}}for(an in al){if(al.hasOwnProperty(an)&&!D(an)){j(an);e(an);delete al[an];delete v[an]}}for(an in v){if(v.hasOwnProperty(an)&&!D(an)){j(an);e(an);delete v[an]}}}function ak(am,an){var ao=null;t.reducedList={};var ap;for(ap in an){if(an.hasOwnProperty(ap)){if(ap===t.myEasyrtcid){ao=an[ap]}else{t.reducedList[ap]=an[ap]}}}ad(t.reducedList);if(ag){ag(am,t.reducedList,ao)}}var aa=function(ao,an){var am={};if(an){an(t.ackMessage)}if(ao.targetEasyrtcid){am.targetEasyrtcid=ao.targetEasyrtcid}if(ao.targetRoom){am.targetRoom=ao.targetRoom}if(ao.targetGroup){am.targetGroup=ao.targetGroup}if(ao.senderEasyrtcid){t.receivePeerDistribute(ao.senderEasyrtcid,ao,am)}else{if(N){N(ao.msgType,ao.msgData,am)}else{console.log("Unhandled server message "+JSON.stringify(ao))}}};var a=function(aq,am){var ap=aq.senderEasyrtcid;var au=aq.msgType;var ar=aq.msgData;var ax;if(t.debugPrinter){t.debugPrinter("received message of type "+au)}if(typeof G[ap]==="undefined"){e(ap)}var ao=function(aA,az){var aC=null;if(window.mozRTCIceCandidate){aC=new mozRTCIceCandidate({sdpMLineIndex:az.label,candidate:az.candidate})}else{aC=new RTCIceCandidate({sdpMLineIndex:az.label,candidate:az.candidate})}ax=k[aA].pc;ax.addIceCandidate(aC);if(az.candidate.indexOf("typ relay")>0){var aB=az.candidate.match(/(udp|tcp) \d+ (\d+\.\d+\.\d+\.\d+)/i)[1];t._turnServers[aB]=true}};var an=function(az){var aA;if(G[az]){for(aA=0;aA<G[az].candidates.length;aA++){ao(az,G[az].candidates[aA])}delete G[az]}};var ay=function(aA,az){var aB=function(aC){if(t.debugPrinter){t.debugPrinter("offer accept="+aC)}delete al[aA];if(!t.supportsPeerConnections()){callFailureCB(t.errCodes.CALL_ERR,t.getConstantString("noWebrtcSupport"));return}if(aC){X(aA,az);an(aA)}else{P(aA,"reject",null,null,null);e(aA)}};if(v[aA]&&aA<t.myEasyrtcid){delete v[aA];if(G[aA]){delete G[aA]}if(k[aA].wasAcceptedCB){k[aA].wasAcceptedCB(true,aA)}delete k[aA];aB(true);return}al[aA]=az;if(!t.acceptCheck){aB(true)}else{t.acceptCheck(aA,aB)}};function aw(az){delete v[az];if(G[az]){delete G[az]}if(k[az]){if(k[az].wasAcceptedCB){k[az].wasAcceptedCB(false,az)}delete k[az]}}function av(aB,aA){delete v[aB];if(k[aB].wasAcceptedCB){k[aB].wasAcceptedCB(true,aB)}var az=function(){};var aE=function(aH,aG){if(k[aB]){delete k[aB]}t.showError(aH,aG)};var aC;k[aB].startedAV=true;for(aC=0;aC<k[aB].candidatesToSend.length;aC++){P(aB,"candidate",k[aB].candidatesToSend[aC],az,aE)}ax=k[aB].pc;var aD=null;if(window.mozRTCSessionDescription){aD=new mozRTCSessionDescription(aA)}else{aD=new RTCSessionDescription(aA)}if(!aD){throw"Could not create the RTCSessionDescription"}if(t.debugPrinter){t.debugPrinter("about to call initiating setRemoteDescription")}try{ax.setRemoteDescription(aD,function(){if(ax.connectDataConnection){if(t.debugPrinter){t.debugPrinter("calling connectDataConnection(5001,5002)")}ax.connectDataConnection(5001,5002)}})}catch(aF){console.log("setRemoteDescription failed ",aF)}an(aB)}function at(aA,az){if(k[aA]&&k[aA].startedAV){ao(aA,az)}else{if(!k[aA]){G[aA]={candidates:[]}}G[aA].candidates.push(az)}}switch(au){case"sessionData":Z(ar.sessionData);break;case"roomData":V(ar.roomData);break;case"iceConfig":J(ar.iceConfig);break;case"forwardToUrl":if(ar.newWindow){window.open(ar.forwardToUrl.url)}else{window.location.href=ar.forwardToUrl.url}break;case"offer":ay(ap,ar);break;case"reject":aw(ap);break;case"answer":av(ap,ar);break;case"candidate":at(ap,ar);break;case"hangup":j(ap);e(ap);break;case"error":t.showError(aq.errorCode,aq.errorText);break;default:console.error("received unknown message type from server, msgType is "+au);return}if(am){am(t.ackMessage)}};function ae(am,an){var ao;if(!t.webSocket){t.webSocket=io.connect(T,{"connect timeout":10000,"force new connection":true});if(!t.webSocket){throw"io.connect failed"}}else{for(ao in t.websocketListeners){if(!t.websocketListeners.hasOwnProperty(ao)){continue}t.webSocket.removeEventListener(t.websocketListeners[ao].event,t.websocketListeners[ao].handler)}}t.websocketListeners=[];function ap(ar,aq){t.webSocket.on(ar,aq);t.websocketListeners.push({event:ar,handler:aq})}ap("close",function(aq){console.log("the web socket closed")});ap("error",function(ar){function aq(){if(t.myEasyrtcid){if(t.webSocket.socket.connected){t.showError(t.errCodes.SIGNAL_ERROR,t.getConstantString("miscSignalError"))}else{console.warn("The connection to the EasyRTC socket server went down. It may come back by itself.")}}else{an(t.errCodes.CONNECT_ERR,t.getConstantString("noServer"))}}setTimeout(aq,1)});ap("connect",function(aq){t.webSocketConnected=true;if(!t.webSocket||!t.webSocket.socket||!t.webSocket.socket.sessionid){t.showError(t.errCodes.CONNECT_ERR,t.getConstantString("badsocket"))}if(t.debugPrinter){t.debugPrinter("saw socketserver onconnect event")}if(t.webSocketConnected){ac(am,an)}else{an(t.errCodes.SIGNAL_ERROR,t.getConstantString("icf"))}});ap("easyrtcMsg",aa);ap("easyrtcCmd",a);ap("disconnect",function(){t.webSocketConnected=false;w=function(){};s={};r();if(t.disconnectListener){t.disconnectListener()}})}function m(aq,an,ap){function ao(at){var ar;for(ar in at){if(at.hasOwnProperty(ar)){return true}}return false}var am={};if(ao(aq)){am.added=aq}if(ao(an)){am.deleted=an}if(ao(am)){return am}else{return null}}function x(an,ar){var ao;var ap={},am={};var aq;for(ao in ar){if(!ar.hasOwnProperty(ao)){}else{if(an===null||typeof an[ao]==="undefined"){ap[ao]=ar[ao]}else{if(typeof ar[ao]==="object"){aq=x(an[ao],ar[ao]);if(aq!==null){ap[ao]=ar[ao]}}else{if(ar[ao]!==an[ao]){ap[ao]=ar[ao]}}}}}for(ao in an){if(!ar.hasOwnProperty(ao)){}else{if(typeof ar[ao]==="undefined"){am=an[ao]}}}return m(ap,am)}function K(){var ao={};var an;for(an in k){if(!k.hasOwnProperty(an)){continue}ao[an]={connectTime:k[an].connectTime,isInitiator:!!k[an].isInitiator}}var am={userSettings:{sharingAudio:!!n.audio,sharingVideo:!!n.video,sharingData:!!af,nativeVideoWidth:t.nativeVideoWidth,nativeVideoHeight:t.nativeVideoHeight,windowWidth:window.innerWidth,windowHeight:window.innerHeight,screenWidth:window.screen.width,screenHeight:window.screen.height,cookieEnabled:navigator.cookieEnabled,os:navigator.oscpu,language:navigator.language}};if(!ai(ao)){am.p2pList=ao}return am}function R(){var am=K(false);var an=function(){var ao=x(s,am);if(ao){if(t.debugPrinter){t.debugPrinter("cfg="+JSON.stringify(ao.added))}if(t.webSocket){P(null,"setUserCfg",{setUserCfg:ao.added},null,null)}}s=am};if(s==={}){an()}else{setTimeout(an,100)}}w=function(){R()};this.updatePresence=function(am,an){t.presenceShow=am;t.presenceStatus=an;if(t.webSocketConnected){P(null,"setPresence",{setPresence:{show:am,status:an}},null)}};this.getSessionFields=function(){return C};this.getSessionField=function(am){if(C[am]){return C[am].fieldValue}else{return undefined}};function Z(am){if(am){if(am.easyrtcsid){t.easyrtcsid=am.easyrtcsid}if(am.field){C=am.field}}}function V(ap){t.roomData=ap;var an;var ar;var ao;var aq,am;for(an in t.roomData){if(!t.roomData.hasOwnProperty(an)){continue}if(ap[an].roomStatus==="join"){if(!(t.roomJoin[an])){t.roomJoin[an]=ap[an]}}else{if(ap[an].roomStatus==="leave"){if(t.roomEntryListener){t.roomEntryListener(false,an)}delete t.roomJoin[an];continue}}if(ap[an].clientList){b[an]=ap[an].clientList}else{if(ap[an].clientListDelta){ao=ap[an].clientListDelta.updateClient;if(ao){for(aq in ao){if(!ao.hasOwnProperty(aq)){continue}if(!b[an]){b[an]=[]}b[an][aq]=ao[aq]}}ar=ap[an].clientListDelta.removeClient;if(ar&&b[an]){for(am in ar){if(ar.hasOwnProperty(am)){delete b[an][am]}}}}}if(t.roomJoin[an]&&ap[an].field){c.rooms[an]=ap[an].field}if(ap[an].roomStatus==="join"){if(t.roomEntryListener){t.roomEntryListener(true,an)}}ak(an,b[an])}t.emitEvent("roomOccupant",b)}this.isTurnServer=function(am){return !!t._turnServers[am]};function J(am){I={iceServers:[]};t._turnServers={};var an;var ap,aq,ar,ao;if(!window.createIceServer){return}for(an=0;an<am.iceServers.length;an++){ap=am.iceServers[an];if(ap.url.indexOf("turn:")===0){if(ap.username){aq=createIceServer(ap.url,ap.username,ap.credential)}else{t.showError("Developer error","Iceserver entry doesn't have a username: "+JSON.stringify(ap))}ao=ap.url.split(/[@:&]/g)[1];t._turnServers[ao]=true}else{aq=ap}if(aq){I.iceServers.push(aq)}}}this.getFreshIceConfig=function(){var am={msgType:"getIceConfig",msgData:{}};t.webSocket.json.emit("easyrtcCmd",am,function(an){if(an.msgType==="iceConfig"){J(an.msgData.iceConfig)}else{t.showError(an.msgData.errorCode,an.msgData.errorText)}})};function ah(an){if(t.debugPrinter){t.debugPrinter("entered process token")}var am=an.msgData;if(am.easyrtcid){t.myEasyrtcid=am.easyrtcid}if(am.field){c.connection=am.field}if(am.iceConfig){J(am.iceConfig)}if(am.sessionData){Z(am.sessionData)}if(am.roomData){V(am.roomData)}if(am.application.field){c.application=am.application.field}}function ac(am,an){var aq,ar,ap;var at=null;if(t.cookieId&&document.cookie){aq=document.cookie.split(/[; ]/g);ar=t.cookieId+"=";for(ap=0;ap<aq.length;ap++){if(aq[ap].indexOf(ar)===0){at=aq[ap].substring(ar.length)}}}if(!t.roomJoin){t.roomJoin={}}var ao={apiVersion:t.apiVersion,applicationName:t.applicationName,setUserCfg:K(true)};if(t.presenceShow){ao.setPresence={show:t.presenceShow,status:t.presenceStatus}}if(t.username){ao.username=t.username}if(t.roomJoin&&!ai(t.roomJoin)){ao.roomJoin=t.roomJoin}if(at){ao.easyrtcsid=at}if(aj){ao.credential=aj}t.webSocket.json.emit("easyrtcAuth",{msgType:"authenticate",msgData:ao},function(av){var au;if(av.msgType==="error"){an(av.msgData.errorCode,av.msgData.errorText);t.roomJoin={}}else{ah(av);if(t._roomApiFields){for(au in t._roomApiFields){if(t._roomApiFields.hasOwnProperty(au)){O(au,t._roomApiFields[au])}}}if(am){am(t.myEasyrtcid)}}})}this.getRoomsJoined=function(){var an={};var am;for(am in t.roomJoin){if(t.roomJoin.hasOwnProperty(am)){an[am]=true}}return an};this.getRoomFields=function(am){if(!c||!c.rooms||!c.rooms[am]){return undefined}return c.rooms[am]};this.getApplicationFields=function(){return c.application};this.getConnectionFields=function(){return c.connection};var W=true;this.dontAddCloseButtons=function(){W=false};function M(ao,ap){var an;if(ao&&!document.getElementById(ao)){t.showError(t.errCodes.DEVELOPER_ERR,"The monitor video id passed to easyApp was bad, saw "+ao);return false}for(an in ap){if(!ap.hasOwnProperty(an)){continue}var am=ap[an];if(!document.getElementById(am)){t.showError(t.errCodes.DEVELOPER_ERR,"The caller video id '"+am+"' passed to easyApp was bad.");return false}}return true}function E(am,at){var ar=at.length;var aw=at;var av=0;var au=null,aq=null;if(!aw){aw=[]}function ax(ay){return(ay.dataset.caller===""||ay.dataset.caller===null||ay.dataset.caller===undefined)}if(!M(am,aw)){throw"bad video element id"}if(am){document.getElementById(am).muted="muted"}t.setOnCall=function(ay){au=ay};t.setOnHangup=function(ay){aq=ay};function ap(ay){if(aw[ay]){return document.getElementById(aw[ay])}else{return null}}t.getIthCaller=function(az){if(az<0||az>aw.length){return null}var ay=ap(az);return ay.dataset.caller};t.getSlotOfCaller=function(az){var ay;for(ay=0;ay<ar;ay++){if(t.getIthCaller(ay)===az){return ay}}return -1};function ao(ay){t.setVideoObjectSrc(ay,"");ay.style.visibility="hidden"}t.setOnStreamClosed(function(ay){var az;for(az=0;az<ar;az++){var aA=ap(az);if(aA.dataset.caller===ay){ao(aA);aA.dataset.caller="";if(aq){aq(ay,az)}}}});t.setAcceptChecker(function(ay,aB){var az;for(az=0;az<ar;az++){var aA=ap(az);if(ax(aA)){aB(true);return}}aB(false)});t.setStreamAcceptor(function(ay,aC){var aA;if(t.debugPrinter){t.debugPrinter("stream acceptor called")}function az(aD,aE){t.setVideoObjectSrc(aD,aE);if(aD.style.visibility){aD.style.visibility="visible"}}var aB;if(av&&ax(av)){az(av,aC);if(au){au(ay,av)}av=null;return}for(aA=0;aA<ar;aA++){aB=ap(aA);if(aB.dataset.caller===ay){az(aB,aC);if(au){au(ay,aA)}return}}for(aA=0;aA<ar;aA++){aB=ap(aA);if(!aB.dataset.caller||ax(aB)){aB.dataset.caller=ay;if(au){au(ay,aA)}az(aB,aC);return}}aB=ap(0);if(aB){t.hangup(aB.dataset.caller);az(aB,aC);if(au){au(ay,0)}}aB.dataset.caller=ay});(function(){var aB,aA,ay,az;if(W){aB=function(aC){aA=aC.parentNode;aC.dataset.caller="";ay=document.createElement("div");ay.className="easyrtc_closeButton";ay.onclick=function(){if(aC.dataset.caller){t.hangup(aC.dataset.caller);ao(aC);aC.dataset.caller=""}};aA.appendChild(ay)};for(az=0;az<ar;az++){aB(ap(az))}}})();var an=null;if(d&&am!==null){an=document.getElementById(am);if(!an){console.error("Programmer error: no object called "+am);return}an.muted="muted";an.defaultMuted=true}}this.easyApp=function(av,am,au,ar,ao){var aq=null,an=null;if(!M(am,au)){throw"bad video id"}E(am,au);t.setGotMedia=function(aw){aq=aw};t.setGotConnection=function(aw){an=aw};var at;at=function(){if(an){an(true,"")}ar(t.myEasyrtcid)};function ap(){if(aq){aq(true,null)}if(am!==null){t.setVideoObjectSrc(document.getElementById(am),t.getLocalStream())}function aw(ay,ax){if(an){an(false,ax)}else{if(ao){ao(t.errCodes.CONNECT_ERR,ax)}else{t.showError(t.errCodes.CONNECT_ERR,ax)}}}t.connect(av,at,aw)}if(t.localStream){ap()}else{t.initMediaSource(ap,function(ax,aw){if(aq){aq(false,aw)}else{if(ao){ao(t.errCodes.MEDIA_ERR,aw)}else{t.showError(t.errCodes.MEDIA_ERR,aw)}}})}};this.initManaged=this.easyApp;this.connect=function(ao,am,an){if(!window.io){t.showError("Developer error","Your HTML has not included the socket.io.js library")}if(t.webSocket){console.error("Developer error: attempt to connect when already connected to socket server");return}I={};H=null;s={};G={};t.applicationName=ao;c={rooms:{},application:{},connection:{}};if(t.debugPrinter){t.debugPrinter("attempt to connect to WebRTC signalling server with application name="+ao)}if(an===null){an=function(aq,ap){console.error("easyrtc.connect: "+ap)}}ae(am,an)}};window.easyrtc=new Easyrtc();easyrtc_constantStrings={unableToEnterRoom:"Unable to enter room {0} because {1}",resolutionWarning:"Requested video size of {0}x{1} but got size of {2}x{3}",badUserName:"Illegal username {0}",localMediaError:"Error getting local media stream: {0}",miscSignalError:"Miscellaneous error from signalling server. It may be ignorable.",noServer:"Unable to reach the EasyRTC signalling server.",badsocket:"Socket.io connect event fired with bad websocket.",icf:"Internal communications failure",statsNotSupported:"call statistics not supported by this browser, try Chrome.",noWebrtcSupport:"Your browser doesn't appear to support WebRTC.",gumFailed:"Failed to get access to local media. Error code was {0}.",requireAudioOrVideo:"At least one of audio and video must be provided"};